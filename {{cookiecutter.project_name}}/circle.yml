general:
    branches:
        ignore:
            - master

machine:
    timezone:
        Europe/Stockholm
    services:
        - postgresql
    python:
        version: 2.7.10

checkout:
    post:
        - mkdir -p logs

dependencies:
    override:
        - pip install -U pip setuptools virtualenv
        - pip install -r src/requirements/test.txt
        - pip install -r deploy/requirements.txt
        - cd frontend && npm install
    pre:
        - openssl aes-256-cbc -d -in .circlerc-crypt -k $KEY >> ~/.circlerc

test:
    pre:
        - cp src/circle.test.env src/.env
    override:
        - cd src && python manage.py test
        - cd frontend && npm run test

deployment:
    stage:
        branch: develop
        commands:
            - cd frontend && npm run build:prod
            - set | grep STAGE_ > "deploy/fabricrc.txt"
            - cd deploy && fabrik stage deploy

    prod:
        tag: /v[0-9]+(\.[0-9]+)*/
        commands:
            - cd frontend && npm run build:prod
            - set | grep PROD_ > "deploy/fabricrc.txt"
            - cd deploy && fabrik prod deploy
